- hosts: all
  tasks:

    - name: Create required files
      file: "{{ item }}"
        state: touch
        ouwner: root
      loop:
        - /etc/modules-load.d/k8s.conf
        - /etc/sysctl.d/k8s.conf

    - name: Install and configure Container Runtime (CRI)
      shell: |
        cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
        overlay
        br_netfilter
        EOF

        sudo modprobe overlay
        sudo modprobe br_netfilter

        # sysctl params required by setup, params persist across reboots
        cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
        net.bridge.bridge-nf-call-iptables  = 1
        net.bridge.bridge-nf-call-ip6tables = 1
        net.ipv4.ip_forward                 = 1
        EOF

        # Apply sysctl params without reboot
        sudo sysctl --system

    - name: Verify br_netfilter and overlay modules are loaded
      ansible.builtin.shell: |
        lsmod | grep br_netfilter
        lsmod | grep overlay
      register: modules

    - name: Print return information of modules
      ansible.builtin.debug:
        var: modules

    - name: Verify net.bridge iptables and net.ipV4_forward variables are set to "1"
      ansible.builtin.shell: |
        sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward
      register: network

    - name: Print return information of network settings
      ansible.builtin.debug:
        var: network
